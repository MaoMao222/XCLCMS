{"version":3,"sources":["app.js"],"names":["app","FileInfo","List","Init","$","XCheck","LogicFile","_this","this","on","DelSubmit","val","SelectFiles","attr","ids","art","dialog","tips","confirm","XGoAjax","ajax","data","attachmentIDs","url","AppConfig","RootUrl","type","callback","opener","call","api","open","close","Update","SaveSubmit","isExclusive","id","angular","module","controller","$scope","initList","success","ops","CustomObject","$apply","delSubmit","paths","complete","delBatchSubmit","filter","window","encodeURIComponent","tabFileUpload","fileModel","IsImage","Path","ImgSmallPath","ImgBigPath","Id","Size","Format","Name","ImgWidth","ImgHeight","ImgPreviewWidth","ImgPreviewHeight","ImgPreviewRatio","X1","Y1","X2","Y2","W","H","ImgX1","ImgY1","ImgX2","ImgY2","ImgCropWidth","ImgCropHeight","ThumbImgSettings","Title","ViewType","DownloadCount","ViewCount","Description","IsUploadSuccess","UploadMsg","thumbImgSettingModel","Width","Height","FileModelList","IsCanAddFile","IsCanUploadFile","IsCanOperateFileItem","_uploader","CurrentFileModel","_jcp","getModelById","result","each","index","n","changeUploadButton","enable","disableBrowse","startUpload","start","clearFunction","progressbar","splice","files","length","refresh","fileEditFunction","tabs","destroy","fileDetailFunction","fileDelFunction","removeFile","map","getCropImgXYInfo","img","x","x2","y","y2","w","h","parseInt","showSourceImg","submit","thumbImgSettingAdd","push","thumbImgSettingDel","idx","setEqualRatioFunction","model","XJ","Data","GetInt","setEqualRatio","m","k","initImgCrop","removeAttr","hide","Jcrop","onSelect","apply","arguments","onChange","onRelease","setSelect","release","$watch","ex","init","plupload","Uploader","browse_button","file_data_name","filters","mime_types","title","extensions","AllowUploadExtInfo","prevent_duplicates","flash_swf_url","silverlight_xap_url","bind","up","lst","file","name","formatSize","size","ContentType","IsGif","slice","lastIndexOf","options","fr","mOxie","FileReader","onload","readAsDataURL","getSource","preloader","Image","load","previewImage","width","height","getAsDataURL","downsize","imgObj","src","Array","Concat","f","settings","multipart_params","FileSetting","JSON","stringify","total","percent","uploader","r","resp","parse","response","Message","IsSuccess","icon","content","ok"],"mappings":"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","file":"app.js","sourcesContent":["/* ./src/js/App.js */\n﻿//文件上传\r\nvar app = {};\r\n\r\napp.FileInfo = {};\r\napp.FileInfo.List = {\r\n    Init: function () {\r\n        $.XCheck();\r\n    }\r\n};\r\n\r\napp.LogicFile = {};\r\napp.LogicFile.List = {\r\n    Init: function () {\r\n        var _this = this;\r\n        $.XCheck();\r\n        $(\"#btnBatchDel\").on(\"click\", function () {\r\n            _this.DelSubmit($(\":checkbox.xcheckValue\").val());\r\n            return false;\r\n        });\r\n        $(\"#btnSelectFiles\").on(\"click\", function () {\r\n            _this.SelectFiles($(\":checkbox.xcheckValue\").val(),$(this).attr(\"callback\"));\r\n            return false;\r\n        });\r\n    },\r\n    DelSubmit: function (ids) {\r\n        if (!ids) {\r\n            art.dialog.tips(\"请指定要删除的记录！\");\r\n            return false;\r\n        }\r\n\r\n        art.dialog.confirm(\"您确定要删除此信息吗？\", function () {\r\n            $.XGoAjax({\r\n                ajax: [{\r\n                    data: { attachmentIDs: ids },\r\n                    url: AppConfig.RootUrl + \"LogicFile/DelSubmit\",\r\n                    type: \"POST\"\r\n                }]\r\n            });\r\n        }, function () {\r\n        });\r\n    },\r\n    SelectFiles: function (ids,callback) {\r\n        if (!ids || !callback) {\r\n            art.dialog.tips(\"请先选择文件再操作！\");\r\n            return false;\r\n        }\r\n        art.dialog.opener[callback].call(null,ids);\r\n        var api = art.dialog.open.api;\r\n        api && api.close();\r\n    }\r\n};\r\napp.LogicFile.Update = {\r\n    Init: function () {\r\n        var _this = this;\r\n        $(\"#btnSave\").on(\"click\", function () {\r\n            _this.SaveSubmit();\r\n            return false;\r\n        });\r\n    },\r\n    SaveSubmit: function () {\r\n        $.XGoAjax({\r\n            isExclusive: true,\r\n            id: \"btnSave\"\r\n        });\r\n    }\r\n};;\n\n/* ./src/js/ng/FileInfoController.js */\n﻿angular.module('ngFileInfo', []).controller('fileInfoList', [\"$scope\",function ($scope) {\r\n    $scope.data = [];\r\n\r\n    $scope.initList = function () {\r\n        $.XGoAjax({\r\n            isExclusive: true,\r\n            id: \"getFileList\",\r\n            ajax: { url: AppConfig.RootUrl + \"FileInfo/GetFileList\" },\r\n            success: function (ops, data) {\r\n                $scope.data = data.CustomObject || [];\r\n                $scope.$apply();\r\n            }\r\n        });\r\n    };\r\n    $scope.initList();\r\n\r\n    $scope.delSubmit = function (paths) {\r\n        if (!paths) {\r\n            art.dialog.tips(\"请指定要删除的文件！\");\r\n            return false;\r\n        }\r\n        art.dialog.confirm(\"您确定要删除此文件吗？\", function () {\r\n            $.XGoAjax({\r\n                ajax: [{\r\n                    data: { paths: paths },\r\n                    url: AppConfig.RootUrl + \"FileInfo/DelSubmit\",\r\n                    type: \"POST\"\r\n                }],\r\n                complete: function () {\r\n                    $scope.initList();\r\n                }\r\n            });\r\n        }, function () {\r\n        });\r\n    };\r\n\r\n    $scope.delBatchSubmit = function () {\r\n        $scope.delSubmit($(\":checkbox.xcheckValue\").val());\r\n    };\r\n\r\n\r\n\r\n}]).filter('encodeURIComponent', function () {\r\n    return window.encodeURIComponent;\r\n});;\n\n/* ./src/js/ng/UploadController.js */\n﻿angular.module('ngUpload', []).controller('fileUpload', [\"$scope\",function ($scope) {\r\n    var tabFileUpload = $(\"#tabFileUpload\");\r\n\r\n    //文件列表中的Model\r\n    var fileModel = function () {\r\n        this.IsImage = false;//是否为图片(不包含gif)\r\n        this.Path = \"\";//原路径\r\n        this.ImgSmallPath = \"\";//较小尺寸（文件为图片时180*180）\r\n        this.ImgBigPath = \"\";//较大尺寸（文件为图片时600*600）\r\n        this.Id = \"\";//选择文件时，自动分配的id\r\n        this.Size = \"\";//文件大小\r\n        this.Format = \"\";//文件格式\r\n        this.Name = \"\";//文件名\r\n        this.ImgWidth = 0;//原图宽度\r\n        this.ImgHeight = 0;//原图高度\r\n        this.ImgPreviewWidth = 0;//裁剪界面中操作的图片的宽度\r\n        this.ImgPreviewHeight = 0;//裁剪界面中操作的图片的高度\r\n        this.ImgPreviewRatio = 0;//当前操作的预览图与原图的比例，因为裁剪的操作是在预览的小图片上面进行的，最终提交上传的时候，是要对原图进行操作，而不是该小图片。\r\n        this.X1 = 0;//编辑预览时的坐标x1\r\n        this.Y1 = 0;//编辑预览时的坐标y1\r\n        this.X2 = 0;//编辑预览时的坐标x2\r\n        this.Y2 = 0;//编辑预览时的坐标y2\r\n        this.W = 0;//编辑预览时，所选的预览图的宽度\r\n        this.H = 0;//编辑预览时，所选的预览图的高度\r\n        this.ImgX1 = 0;//裁剪后的坐标x1\r\n        this.ImgY1 = 0;//裁剪后的坐标y1\r\n        this.ImgX2 = 0;//裁剪后的坐标x2\r\n        this.ImgY2 = 0;//裁剪后的坐标y2\r\n        this.ImgCropWidth = 0;//裁剪后最终图片的宽度\r\n        this.ImgCropHeight = 0;//裁剪后最终图片的高度\r\n        this.ThumbImgSettings = [];//要生成的缩略图选项设置\r\n\r\n        this.Title = \"\";//文件标题\r\n        this.ViewType = \"NOR\";//查看类型\r\n        this.DownloadCount = 0;//下载数\r\n        this.ViewCount = 0;//查看数\r\n        this.Description = \"\";//描述\r\n\r\n        this.IsUploadSuccess = false;//是否上传成功\r\n        this.UploadMsg = \"\";//上传结果消息\r\n    };\r\n\r\n    //文件编辑中缩略图设置model\r\n    var thumbImgSettingModel = function () {\r\n        this.Width = 0;//宽度\r\n        this.Height = 0;//高度\r\n    };\r\n\r\n    //当前文件列表\r\n    $scope.FileModelList = [];\r\n\r\n    //是否允许添加待上传文件\r\n    $scope.IsCanAddFile = true;\r\n\r\n    //是否允许开始上传的操作\r\n    $scope.IsCanUploadFile = true;\r\n\r\n    //是否允许操作每一个文件下方的按钮\r\n    $scope.IsCanOperateFileItem = true;\r\n\r\n    //当前在操作中的model（如：查询该文件详情、修改该文件信息）\r\n    $scope.CurrentFileModel = null;\r\n\r\n    //上传对象\r\n    var _uploader = null;\r\n\r\n    //编辑时的图片裁剪对象\r\n    var _jcp = null;\r\n\r\n    /**\r\n     * 根据文件id，返回该文件的json model信息\r\n     */\r\n    var getModelById = function (id) {\r\n        var result = null, _this = this;\r\n        if ($scope.FileModelList) {\r\n            $.each($scope.FileModelList, function (index, n) {\r\n                if (n.Id == id) {\r\n                    result = n;\r\n                    return false;\r\n                }\r\n            });\r\n        }\r\n        return result;\r\n    };\r\n\r\n    /**\r\n     * 根据文件id，删除该文件的json model信息\r\n     */\r\n    var removeModelById = function (id) {\r\n        if ($scope.FileModelList) {\r\n            $scope.FileModelList = $.map($scope.FileModelList, function (n) {\r\n                return n.Id == id ? null : n;\r\n            });\r\n        }\r\n        if ($scope.CurrentFileModel && id === $scope.CurrentFileModel.Id) {\r\n            $scope.CurrentFileModel = null;\r\n        }\r\n    };\r\n\r\n    /*******************************文件列表页开始*************************************/\r\n\r\n    /**\r\n    *改变上传按钮的相关状态（可用、不可用）\r\n    */\r\n    var changeUploadButton = function (enable) {\r\n        if (enable) {\r\n            _uploader.disableBrowse(false);\r\n            $scope.IsCanAddFile = true;\r\n            $scope.IsCanUploadFile = true;\r\n            $scope.IsCanOperateFileItem = true;\r\n        } else {\r\n            _uploader.disableBrowse(true);\r\n            $scope.IsCanAddFile = false;\r\n            $scope.IsCanUploadFile = false;\r\n            $scope.IsCanOperateFileItem = false;\r\n            $scope.CurrentFileModel = null;\r\n        }\r\n    };\r\n\r\n    //单击开始上传文件\r\n    $scope.startUpload = function () {\r\n        if (_uploader) {\r\n            _uploader.start();\r\n        }\r\n    };\r\n\r\n    //单击清空重来\r\n    $scope.clearFunction = function () {\r\n        $(\"#fileUploaderProgress\").progressbar(\"setValue\", 0);\r\n        $scope.FileModelList = [];\r\n        $scope.CurrentFileModel = null;\r\n        _uploader.splice(0, _uploader.files.length);\r\n        _uploader.refresh();\r\n        changeUploadButton(true);\r\n    };\r\n\r\n    //单击修改文件\r\n    $scope.fileEditFunction = function (id) {\r\n        tabFileUpload.tabs('select', \"文件设置\");\r\n        if ($scope.CurrentFileModel && id == $scope.CurrentFileModel.Id) {\r\n            return false;\r\n        }\r\n        if (_jcp) {\r\n            _jcp.destroy();\r\n        }\r\n        $scope.CurrentFileModel = getModelById(id);\r\n        if (null == $scope.CurrentFileModel.ThumbImgSettings || $scope.CurrentFileModel.ThumbImgSettings.length == 0) {\r\n            $scope.CurrentFileModel.ThumbImgSettings = [new thumbImgSettingModel()];\r\n        }\r\n    };\r\n\r\n    //单击文件详情\r\n    $scope.fileDetailFunction = function (id) {\r\n        tabFileUpload.tabs('select', \"文件详情\");\r\n        if ($scope.CurrentFileModel && id == $scope.CurrentFileModel.Id) {\r\n            return false;\r\n        }\r\n        if (_jcp) {\r\n            _jcp.destroy();\r\n        }\r\n        $scope.CurrentFileModel = getModelById(id);\r\n    };\r\n\r\n    //单击删除文件\r\n    $scope.fileDelFunction = function (id) {\r\n        _uploader.removeFile(id);\r\n        removeModelById(id);\r\n    };\r\n\r\n    /*******************************文件设置页开始*************************************/\r\n\r\n    /**\r\n     * 图片预览\r\n     */\r\n    var previewImage = function (options) {\r\n        if (!options.file || !XJ.ContentType.IsImage(options.file.type) || XJ.ContentType.IsGif(options.file.type)) return; //确保文件是图片\r\n        if (XJ.ContentType.IsGif(options.file.type)) {//gif使用FileReader进行预览,因为mOxie.Image只支持jpg和png\r\n            var fr = new mOxie.FileReader();\r\n            fr.onload = function () {\r\n                options.callback(fr.result);\r\n                fr.destroy();\r\n                fr = null;\r\n            };\r\n            fr.readAsDataURL(options.file.getSource());\r\n        } else {\r\n            var preloader = new mOxie.Image();\r\n            preloader.onload = function () {\r\n                options.callback && options.callback(preloader);\r\n                preloader.destroy();\r\n                preloader = null;\r\n            };\r\n            preloader.load(options.file.getSource());\r\n        }\r\n    };\r\n\r\n    //图片裁剪\r\n    var getCropImgXYInfo = function (img) {\r\n        $scope.CurrentFileModel.X1 = img.x;\r\n        $scope.CurrentFileModel.X2 = img.x2;\r\n        $scope.CurrentFileModel.Y1 = img.y;\r\n        $scope.CurrentFileModel.Y2 = img.y2;\r\n        $scope.CurrentFileModel.W = img.w;\r\n        $scope.CurrentFileModel.H = img.h;\r\n        $scope.CurrentFileModel.ImgX1 = parseInt(img.x / $scope.CurrentFileModel.ImgPreviewRatio);\r\n        $scope.CurrentFileModel.ImgX2 = parseInt(img.x2 / $scope.CurrentFileModel.ImgPreviewRatio);\r\n        $scope.CurrentFileModel.ImgY1 = parseInt(img.y / $scope.CurrentFileModel.ImgPreviewRatio);\r\n        $scope.CurrentFileModel.ImgY2 = parseInt(img.y2 / $scope.CurrentFileModel.ImgPreviewRatio);\r\n        $scope.CurrentFileModel.ImgCropWidth = parseInt(img.w / $scope.CurrentFileModel.ImgPreviewRatio);\r\n        $scope.CurrentFileModel.ImgCropHeight = parseInt(img.h / $scope.CurrentFileModel.ImgPreviewRatio);\r\n    };\r\n\r\n    //单击查看原图\r\n    $scope.showSourceImg = function () {\r\n        $(\"#formShowImg\").submit();\r\n    };\r\n\r\n    //添加缩略图配置行\r\n    $scope.thumbImgSettingAdd = function () {\r\n        $scope.CurrentFileModel.ThumbImgSettings.push(new thumbImgSettingModel());\r\n    };\r\n\r\n    //删除缩略图配置行\r\n    $scope.thumbImgSettingDel = function (idx) {\r\n        $scope.CurrentFileModel.ThumbImgSettings.splice(idx, 1);\r\n    };\r\n\r\n    var setEqualRatioFunction = function (model) {\r\n        if (model.Width) {\r\n            model.Height = XJ.Data.GetInt((model.Width * $scope.CurrentFileModel.ImgCropHeight) / $scope.CurrentFileModel.ImgCropWidth);\r\n        } else {\r\n            model.Width = XJ.Data.GetInt((model.Height * $scope.CurrentFileModel.ImgCropWidth) / $scope.CurrentFileModel.ImgCropHeight);\r\n        }\r\n    };\r\n\r\n    //设置缩略图的等比值\r\n    $scope.setEqualRatio = function (m) {\r\n        if (m) {\r\n            setEqualRatioFunction.call(this, m);\r\n            return;\r\n        }\r\n        $.each($scope.CurrentFileModel.ThumbImgSettings, function (idx, k) {\r\n            setEqualRatioFunction.call(this, k);\r\n        });\r\n    };\r\n\r\n    //图片编辑时，初始化裁剪插件\r\n    $scope.initImgCrop = function () {\r\n        $(\"img#ImgToEdit\").removeAttr(\"style\").hide().Jcrop({\r\n            onSelect: function () {\r\n                getCropImgXYInfo.apply(this, arguments);\r\n                $scope.$apply();\r\n            },\r\n            onChange: function () {\r\n                getCropImgXYInfo.apply(this, arguments);\r\n                $scope.$apply();\r\n            },\r\n            onRelease: function () {\r\n                if ($scope.CurrentFileModel.ImgCropWidth == 0 || $scope.CurrentFileModel.ImgCropWidth == 0) {\r\n                    this.setSelect([0, 0, $scope.CurrentFileModel.ImgPreviewWidth, $scope.CurrentFileModel.ImgPreviewHeight]);\r\n                } else {\r\n                    this.setSelect([$scope.CurrentFileModel.X1, $scope.CurrentFileModel.Y1, $scope.CurrentFileModel.X2, $scope.CurrentFileModel.Y2]);\r\n                }\r\n            }\r\n        }, function () {\r\n            _jcp = this;\r\n            this.release.call(this);\r\n        });\r\n    };\r\n\r\n    $scope.$watch(\"CurrentFileModel\", function (model) {\r\n        //tab选项卡状态更新\r\n        try {\r\n            if (model) {\r\n                tabFileUpload.tabs('enableTab', \"文件详情\");\r\n                tabFileUpload.tabs('enableTab', \"文件设置\");\r\n            } else {\r\n                tabFileUpload.tabs('select', \"选择文件\");\r\n                tabFileUpload.tabs('disableTab', \"文件详情\");\r\n                tabFileUpload.tabs('disableTab', \"文件设置\");\r\n            }\r\n        } catch (ex) { }\r\n        //计算等比值更新\r\n        if (model) {\r\n            $scope.setEqualRatio();\r\n        }\r\n    }, true);\r\n\r\n    //初始化\r\n    $scope.init = function () {\r\n        //初始化上传\r\n        _uploader = new plupload.Uploader({\r\n            browse_button: 'btnAddFile',\r\n            url: AppConfig.RootUrl + 'Upload/UploadSubmit',\r\n            file_data_name: \"FileInfo\",\r\n            filters: {\r\n                mime_types: [{ title: \"选择文件\", extensions: window.AppConfig.AllowUploadExtInfo }],\r\n                prevent_duplicates: true\r\n            },\r\n            flash_swf_url: AppConfig.RootUrl + \"Resources/src/js/plupload/Moxie.swf\",\r\n            silverlight_xap_url: AppConfig.RootUrl + \"Resources/src/js/plupload/Moxie.xap\"\r\n        });\r\n        _uploader.init();\r\n\r\n        //文件被添加进来的事件\r\n        _uploader.bind('FilesAdded', function (up, files) {\r\n            var lst = [];\r\n            plupload.each(files, function (file) {\r\n                var model = new fileModel();\r\n                model.Id = file.id;\r\n                model.Name = file.name;\r\n                model.Size = plupload.formatSize(file.size);\r\n                model.IsImage = XJ.ContentType.IsImage(file.type) && !XJ.ContentType.IsGif(file.type);\r\n                model.Format = file.name.slice(file.name.lastIndexOf(\".\") + 1);\r\n                //生成预览图\r\n                previewImage({\r\n                    file: file,\r\n                    callback: function (preloader) {\r\n                        model.ImgWidth = preloader.width;\r\n                        model.ImgHeight = preloader.height;\r\n                        model.Path = preloader.getAsDataURL();\r\n\r\n                        preloader.downsize(180, 180);//预览图片的最大宽高，自动等比。\r\n                        model.ImgSmallPath = preloader.getAsDataURL();\r\n\r\n                        var imgObj = new mOxie.Image();\r\n                        imgObj.onload = function () {\r\n                            imgObj.downsize(600, 600);\r\n                            model.ImgBigPath = imgObj.getAsDataURL();\r\n                            model.ImgPreviewWidth = imgObj.width;\r\n                            model.ImgPreviewHeight = imgObj.height;\r\n                            model.ImgPreviewRatio = model.ImgPreviewWidth / model.ImgWidth;\r\n                            preloader.destroy();\r\n                            preloader = null;\r\n                        };\r\n                        imgObj.load(file.getSource());\r\n\r\n                        $(\"img#\" + file.id).attr({ src: model.ImgSmallPath });\r\n                    }\r\n                });\r\n                lst.push(model);\r\n            });\r\n            $scope.FileModelList = XJ.Array.Concat($scope.FileModelList, lst);\r\n            $scope.$apply();\r\n        });\r\n        //文件上传前事件\r\n        _uploader.bind(\"BeforeUpload\", function (up,file) {\r\n            changeUploadButton(false);\r\n            var f = $.map($scope.FileModelList, function (n) {\r\n                return file.id == n.Id ? n : null;\r\n            });\r\n            if (f && f.length > 0) {\r\n                //去掉不使用的image-data数据，避免post到服务器\r\n                f[0].ImgSmallPath = \"\";\r\n                f[0].ImgBigPath = \"\";\r\n                f[0].Path = \"\";\r\n            }\r\n            up.settings.multipart_params = { FileSetting: JSON.stringify(f[0]) };\r\n        });\r\n        //文件上传中的事件\r\n        _uploader.bind(\"UploadProgress\", function (up, file) {\r\n            $(\"#fileUploaderProgress\").progressbar(\"setValue\", up.total.percent);\r\n        });\r\n        //当队列中的某一个文件上传完成后触发\r\n        _uploader.bind(\"FileUploaded\", function (uploader, file, r) {\r\n            var resp = JSON.parse(r.response);\r\n            var m = getModelById(file.id);\r\n            m.UploadMsg = resp.Message;\r\n            m.IsUploadSuccess = resp.IsSuccess;\r\n            $scope.$apply();\r\n        });\r\n        //所有文件上传完成后事件\r\n        _uploader.bind(\"UploadComplete\", function (up, files) {\r\n            if (files.length == 0) {\r\n                art.dialog({\r\n                    icon: \"face-smile\",\r\n                    content: \"当前没有待上传的文件！\",\r\n                    ok: true\r\n                });\r\n            }\r\n        });\r\n    };\r\n    $scope.init();\r\n}]);\r\n\r\n$(function () {\r\n    var tabFileUpload = $(\"#tabFileUpload\");\r\n    tabFileUpload.tabs('disableTab', \"文件详情\");\r\n    tabFileUpload.tabs('disableTab', \"文件设置\");\r\n});\r\n;\n\n"]}